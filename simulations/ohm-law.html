<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resistance Finder: Linear Regression</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
        }
        .canvas-container {
            position: relative;
            height: 400px;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .sidebar {
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
        }
        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2563eb;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
        }
        .feedback-pill {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .fb-high { background: #fee2e2; color: #991b1b; } 
        .fb-low { background: #dbeafe; color: #1e40af; } 
        .fb-good { background: #d1fae5; color: #065f46; } 
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Controls -->
    <div class="sidebar w-full md:w-1/3 p-6 flex flex-col gap-4 overflow-y-auto">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">AI Resistance Lab</h1>
            <p class="text-sm text-slate-500 mb-4">Train a model to find Resistance using V vs I.</p>
        </div>

        <!-- Input Section -->
        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
            <h3 class="font-semibold mb-2 text-slate-700">1. Collect Data</h3>
            <div class="flex gap-2 mb-2">
                <div class="w-1/2">
                    <label class="text-xs font-bold text-slate-500">Voltage (V)</label>
                    <input type="number" id="inputV" class="w-full p-2 border rounded" placeholder="e.g. 2.0">
                </div>
                <div class="w-1/2">
                    <label class="text-xs font-bold text-slate-500">Current (A)</label>
                    <input type="number" id="inputI" class="w-full p-2 border rounded" placeholder="e.g. 0.4">
                </div>
            </div>
            <button onclick="addDataPoint()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition mb-2">
                + Add Data Point
            </button>
            
            <!-- QR Sharing Buttons -->
            <div class="flex gap-2 mb-2">
                <button onclick="showQRModal()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-2 rounded transition flex items-center justify-center gap-1">
                    ðŸ“± Share Data (QR)
                </button>
                <button onclick="showScanModal()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold py-2 px-2 rounded transition flex items-center justify-center gap-1">
                    ðŸ“· Scan Data
                </button>
            </div>

            <div class="mt-2 max-h-32 overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <thead>
                        <tr class="border-b">
                            <th class="py-1">V</th>
                            <th class="py-1">I</th>
                            <th class="py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <!-- Data rows go here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Controls -->
        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
            <h3 class="font-semibold mb-2 text-slate-700">2. Train Model (Gradient Descent)</h3>
            
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="stat-card">
                    <div class="stat-value" id="dispEpoch">0</div>
                    <div class="stat-label">Steps Taken</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-red-500" id="dispError">0.00</div>
                    <div class="stat-label">Total Error (Cost)</div>
                </div>
            </div>

            <!-- Gradient Analysis Feedback -->
            <div class="mb-3 p-3 bg-white rounded border border-slate-200 text-sm">
                <div class="font-bold text-slate-600 mb-1 border-b pb-1">Gradient Analysis</div>
                <div class="flex justify-between items-center mb-1">
                    <span>Slope (m):</span>
                    <span id="mFeedback" class="feedback-pill bg-slate-100 text-slate-500">Waiting...</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Intercept (c):</span>
                    <span id="cFeedback" class="feedback-pill bg-slate-100 text-slate-500">Waiting...</span>
                </div>
            </div>

            <div class="flex gap-2 mb-2">
                <button onclick="initModel()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded text-sm">
                    Reset / Randomize Line
                </button>
            </div>
            <div class="flex gap-2">
                <button id="btnStep" onclick="trainStep()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    1 Step Descent
                </button>
                <button id="btnAuto" onclick="toggleAutoTrain()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    â–¶ Auto Train
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <h3 class="font-semibold mb-2 text-green-800">3. AI Prediction</h3>
            <p class="text-sm text-slate-600 mb-1">Model: <span class="font-mono bg-white px-1 rounded">I = (<span id="dispM">0.00</span>)V + <span id="dispC">0.00</span></span></p>
            <hr class="my-2 border-green-200">
            <div class="flex justify-between items-center">
                <span class="text-sm font-bold text-slate-600">Predicted Resistance (R):</span>
                <span class="text-2xl font-bold text-green-700"><span id="dispR">--</span> Î©</span>
            </div>
            <p class="text-xs text-slate-400 mt-1">Derived from slope (m = 1/R)</p>
        </div>
    </div>

    <!-- Visualization Area -->
    <div class="flex-1 p-6 bg-slate-100 flex flex-col justify-center items-center">
        <div class="canvas-container p-4">
            <canvas id="regressionChart"></canvas>
        </div>
        <div class="mt-4 text-center max-w-lg text-sm text-slate-500">
            <p><strong>How it works:</strong> The AI starts with a random guess (red line). When you click "Step", it calculates the gradient to see if the slope is too high or too low, then adjusts the line to minimize the Error.</p>
        </div>
    </div>

    <!-- MODALS -->
    <!-- QR Display Modal -->
    <div id="qrModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Share Data with Teacher</h3>
            <div id="qrcode" class="flex justify-center mb-4"></div>
            <p class="text-sm text-gray-500 mb-4">Scan this code to add your data points to the teacher's device.</p>
            <button onclick="closeQRModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Close</button>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scanModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Scan Student Data</h3>
            <div id="reader" width="400px" class="mb-4"></div>
            <div id="scanResult" class="text-sm text-green-600 font-bold mb-2"></div>
            <button onclick="closeScanModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Stop Scanning</button>
        </div>
    </div>

    <script>
        // --- State ---
        let dataPoints = [];
        let m = 0; // Slope
        let c = 0; // Intercept (Bias)
        let learningRate = 0.01;
        let epoch = 0;
        let isAutoTraining = false;
        let autoTrainInterval;
        let chart;
        let html5QrcodeScanner = null;

        // --- Initialization ---
        window.onload = function() {
            initChart();
            // Pre-load some sample data for better UX
            addDataInternal(1, 0.2);
            addDataInternal(2, 0.42);
            addDataInternal(3, 0.58);
            addDataInternal(4, 0.85);
            addDataInternal(5, 0.98);
            initModel();
        };

        // --- Chart.js Setup ---
        function initChart() {
            const ctx = document.getElementById('regressionChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Experimental Data (V, I)',
                            data: [],
                            borderColor: '#2563eb',
                            backgroundColor: '#2563eb',
                            pointStyle: 'crossRot', 
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderWidth: 2
                        },
                        {
                            label: 'AI Best Fit Line',
                            data: [],
                            type: 'line',
                            borderColor: '#ef4444',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: false,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Voltage (V)', font: {size: 14, weight: 'bold'} },
                            min: 0,
                            suggestedMax: 6
                        },
                        y: {
                            title: { display: true, text: 'Current (I)', font: {size: 14, weight: 'bold'} },
                            min: 0,
                            suggestedMax: 1.5
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `(${context.parsed.x}V, ${context.parsed.y}A)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Data Management ---
        function addDataPoint() {
            const v = parseFloat(document.getElementById('inputV').value);
            const i = parseFloat(document.getElementById('inputI').value);

            if (isNaN(v) || isNaN(i)) {
                alert("Please enter valid numbers for Voltage and Current.");
                return;
            }

            addDataInternal(v, i);
            
            document.getElementById('inputV').value = '';
            document.getElementById('inputI').value = '';
            document.getElementById('inputV').focus();
        }

        function addDataInternal(v, i) {
            dataPoints.push({ x: v, y: i });
            
            const table = document.getElementById('dataTable');
            const row = table.insertRow();
            row.innerHTML = `
                <td class="py-1 px-2 border-b">${v}</td>
                <td class="py-1 px-2 border-b">${i}</td>
                <td class="py-1 px-2 border-b text-right"><button onclick="removeData(this, ${v}, ${i})" class="text-red-500 hover:text-red-700">Ã—</button></td>
            `;

            updateChartData();
            enableButtons();
        }

        function removeData(btn, v, i) {
            dataPoints = dataPoints.filter(p => p.x !== v || p.y !== i);
            const row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
            updateChartData();
        }

        // --- QR Sharing & Scanning ---

        function showQRModal() {
            if(dataPoints.length === 0) {
                alert("No data to share! Add points first.");
                return;
            }
            document.getElementById('qrModal').style.display = 'flex';
            document.getElementById('qrcode').innerHTML = '';
            
            // COMPRESS DATA: Convert [{x:1,y:2}...] to [[1,2]...]
            // This reduces QR density significantly, making scanning much easier.
            const simplifiedData = dataPoints.map(p => [p.x, p.y]);
            const dataStr = JSON.stringify(simplifiedData);
            
            new QRCode(document.getElementById("qrcode"), {
                text: dataStr,
                width: 256, // Larger size for clarity
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function showScanModal() {
            document.getElementById('scanModal').style.display = 'flex';
            document.getElementById('scanResult').innerText = "";
            
            // Init Scanner with better mobile configs
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                });
            
            // Handle success and ignore intermediate failures to prevent alert spam
            html5QrcodeScanner.render(onScanSuccess, (error) => {
                // onScanFailure callback: intentionally empty to suppress console noise
            });
        }

        function closeScanModal() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }
            document.getElementById('scanModal').style.display = 'none';
        }

        function onScanSuccess(decodedText, decodedResult) {
            try {
                const newData = JSON.parse(decodedText);
                
                if(Array.isArray(newData)) {
                    let addedCount = 0;
                    newData.forEach(pt => {
                        // Handle Compressed Array [x,y]
                        if(Array.isArray(pt) && pt.length === 2) {
                            addDataInternal(pt[0], pt[1]);
                            addedCount++;
                        } 
                        // Handle Legacy Object {x,y}
                        else if(pt.hasOwnProperty('x') && pt.hasOwnProperty('y')) {
                            addDataInternal(pt.x, pt.y);
                            addedCount++;
                        }
                    });
                    
                    if(addedCount > 0) {
                        document.getElementById('scanResult').innerText = `Success! Added ${addedCount} points.`;
                        // Beep or visual feedback
                    } else {
                        document.getElementById('scanResult').innerText = "QR valid but contained no points.";
                    }
                } else {
                    document.getElementById('scanResult').innerText = "Invalid data format.";
                }
            } catch(e) {
                console.error(e);
                document.getElementById('scanResult').innerText = "Error parsing QR data.";
            }
        }

        // --- AI / Linear Regression Logic ---

        function initModel() {
            if (dataPoints.length < 2) {
                m = 0; c = 0;
            } else {
                m = Math.random() * 0.5; 
                c = Math.random() * 0.5;
            }
            
            epoch = 0;
            updateDisplay(null, null, null); 
            drawRegressionLine();
            enableButtons();
            if(isAutoTraining) toggleAutoTrain(); 
        }

        function trainStep() {
            if (dataPoints.length === 0) return;

            let learning_rate = 0.01; 
            let m_gradient = 0;
            let c_gradient = 0;
            let N = dataPoints.length;
            let totalError = 0;

            for (let i = 0; i < N; i++) {
                let x = dataPoints[i].x;
                let y = dataPoints[i].y;
                let guess = (m * x) + c;
                let error = guess - y; 
                totalError += (error * error); 

                m_gradient += (2/N) * error * x;
                c_gradient += (2/N) * error;
            }

            m = m - (learning_rate * m_gradient);
            c = c - (learning_rate * c_gradient);

            epoch++;
            updateDisplay(totalError, m_gradient, c_gradient);
            drawRegressionLine();
        }

        function toggleAutoTrain() {
            if (isAutoTraining) {
                clearInterval(autoTrainInterval);
                isAutoTraining = false;
                document.getElementById('btnAuto').innerText = "â–¶ Auto Train";
                document.getElementById('btnStep').disabled = false;
            } else {
                isAutoTraining = true;
                document.getElementById('btnAuto').innerText = "â¸ Pause";
                document.getElementById('btnStep').disabled = true;
                autoTrainInterval = setInterval(trainStep, 100); 
            }
        }

        // --- Visualization & UI Updates ---

        function drawRegressionLine() {
            let maxX = 0;
            dataPoints.forEach(p => { if(p.x > maxX) maxX = p.x; });
            maxX = maxX * 1.2; 
            if(maxX < 5) maxX = 5;

            const startPoint = { x: 0, y: c };
            const endPoint = { x: maxX, y: (m * maxX) + c };

            chart.data.datasets[1].data = [startPoint, endPoint];
            chart.update();
        }

        function updateChartData() {
            chart.data.datasets[0].data = [...dataPoints];
            chart.update();
        }

        function updateDisplay(errorVal, mGrad, cGrad) {
            document.getElementById('dispEpoch').innerText = epoch;
            document.getElementById('dispM').innerText = m.toFixed(4);
            document.getElementById('dispC').innerText = c.toFixed(4);
            
            if (errorVal !== null) {
                document.getElementById('dispError').innerText = errorVal.toFixed(4);
            }

            // Feedback Logic
            if (mGrad !== null && cGrad !== null) {
                updateFeedbackPill('mFeedback', mGrad);
                updateFeedbackPill('cFeedback', cGrad);
            } else {
                resetFeedbackPill('mFeedback');
                resetFeedbackPill('cFeedback');
            }

            // Calculate Resistance
            let R = 0;
            if (m > 0.0001) {
                R = 1 / m;
                document.getElementById('dispR').innerText = R.toFixed(2);
            } else {
                document.getElementById('dispR').innerText = "--";
            }
        }

        function updateFeedbackPill(id, gradient) {
            const el = document.getElementById(id);
            const threshold = 0.001; 
            
            if (gradient > threshold) {
                el.className = "feedback-pill fb-high";
                el.innerText = "Too Large (â†“ Reducing)";
            } else if (gradient < -threshold) {
                el.className = "feedback-pill fb-low";
                el.innerText = "Too Small (â†‘ Increasing)";
            } else {
                el.className = "feedback-pill fb-good";
                el.innerText = "Perfect";
            }
        }

        function resetFeedbackPill(id) {
            const el = document.getElementById(id);
            el.className = "feedback-pill bg-slate-100 text-slate-500";
            el.innerText = "Waiting...";
        }

        function enableButtons() {
            const hasData = dataPoints.length > 0;
            document.getElementById('btnStep').disabled = !hasData;
            document.getElementById('btnAuto').disabled = !hasData;
        }

    </script>
</body>
</html>