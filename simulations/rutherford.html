<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Rutherford vs Thomson Scattering</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9; 
            color: #333; 
            margin: 0;
            padding: 0;
            /* FIX: Use dynamic viewport height to account for Safari toolbars */
            height: 100vh;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll */
        }

        header {
            padding: 10px; /* Reduced padding */
            text-align: center;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            flex-shrink: 0;
            border-bottom: 1px solid #eee;
        }

        h1 {
            margin: 0;
            font-size: 1.1rem; /* Compact header */
            color: #222;
        }

        .simulation-area {
            flex-grow: 1;
            position: relative;
            width: 100%;
            background: #ffffff;
            overflow: hidden;
            /* FIX: Allow flexbox to shrink this area if needed */
            height: 0; 
            min-height: 0;
            border-bottom: 1px solid #333;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .controls {
            background: #1e1e1e;
            padding: 10px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #333;
            flex-shrink: 0;
            color: #e0e0e0;
            /* FIX: Handle scrolling within controls if screen is very short */
            max-height: 50vh;
            overflow-y: auto;
            /* FIX: Add padding for iPhone Home Indicator */
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 0.75rem;
            color: #aaa;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn-group {
            display: flex;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
        }

        button {
            background: #333;
            color: #ccc;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        button:hover { background: #444; }
        
        button.active {
            background: #00bcd4;
            color: #000;
        }

        /* Specific buttons */
        #btn-pause, #btn-toggle-atoms {
            background: #444;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
        }
        #btn-pause:hover, #btn-toggle-atoms:hover {
            background: #555;
        }
        #btn-toggle-atoms.active {
            background: #00bcd4;
            color: #000;
        }

        input[type="range"] {
            width: 140px;
            cursor: pointer;
        }

        .stats {
            font-family: monospace;
            font-size: 0.8rem;
            background: #2c2c2c;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #ff9800;
            color: #aaa;
        }

        .legend-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: #333;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
    </style>
</head>
<body>

    <header>
        <h1>Alpha Particle Scattering Experiment</h1>
    </header>

    <div class="simulation-area">
        <canvas id="simCanvas"></canvas>
        <div class="legend-overlay">
            <div class="legend-item">
                <span class="dot" style="background:#1565C0;"></span> Alpha Particle
            </div>
            <div class="legend-item" id="legend-target">
                <span class="dot" style="background:#ff5722;"></span> Gold Nucleus
            </div>
            <div style="margin-top:5px; font-size: 0.75rem; color:#666; max-width: 200px;" id="model-explanation">
                Positive charge is spread out. The weak electric field causes only minor deviations. No backscattering.
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Atomic Model</label>
            <div class="btn-group">
                <button id="btn-plum" class="active">Plum Pudding</button>
                <button id="btn-rutherford">Rutherford</button>
            </div>
        </div>

        <div class="control-group">
            <label>Beam Speed</label>
            <input type="range" id="speed-slider" min="5" max="25" value="12">
        </div>

        <div class="control-group">
            <div style="display: flex; gap: 8px;">
                <button id="btn-pause" style="flex: 1;">Pause</button>
                <button id="btn-toggle-atoms" class="active" style="flex: 1;">Show Structure</button>
            </div>
        </div>

        <div class="control-group">
            <label>Statistics</label>
            <div class="stats">
                Fired: <span id="count-total">0</span><br>
                Back-scattered: <span id="count-hit">0</span>
            </div>
        </div>

        <button id="btn-clear" style="border-radius: 6px; background: #ff5252; color: white;">Clear Trails</button>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.querySelector('.simulation-area');

        // State
        let width, height;
        let particles = [];
        let atoms = [];
        let MODE = 'plum'; 
        
        // Counters
        let totalParticles = 0;
        let backScatters = 0;
        let spawnTimer = 0;

        // Physics Constants
        const RUTH_K = 2000; 
        const PLUM_K = 15;    
        const ATOM_RADIUS_PLUM = 60; 
        const ATOM_RADIUS_RUTH = 4; 
        
        // UI Elements
        const uiTotal = document.getElementById('count-total');
        const uiHit = document.getElementById('count-hit');
        const btnPlum = document.getElementById('btn-plum');
        const btnRuth = document.getElementById('btn-rutherford');
        const speedSlider = document.getElementById('speed-slider');
        const legendText = document.getElementById('model-explanation');
        const btnPause = document.getElementById('btn-pause');
        const btnToggleAtoms = document.getElementById('btn-toggle-atoms');

        let isPaused = false;
        let showStructure = false; 

        // --- Resizing Logic ---
        function resize() {
            width = container.clientWidth;
            height = container.clientHeight;
            
            canvas.width = width;
            canvas.height = height;
            
            initAtoms();
        }
        window.addEventListener('resize', resize);

        // --- Classes ---

        class Atom {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }

            draw(showDetails) {
                // Consistent Visual Radius for ALL modes (1.5x base)
                const visualRadius = ATOM_RADIUS_PLUM * 1.5;

                if (!showDetails) {
                    // Hidden Structure Mode
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, visualRadius, 0, Math.PI * 2);
                    
                    // Dotted Dark Gray Line
                    ctx.strokeStyle = 'rgba(80, 80, 80, 0.6)'; 
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]); 
                    ctx.stroke();
                    ctx.setLineDash([]); 
                    return;
                }

                if (MODE === 'rutherford') {
                    // Tiny Nucleus
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, ATOM_RADIUS_RUTH, 0, Math.PI * 2);
                    ctx.fillStyle = '#ff5722'; 
                    ctx.fill();
                    
                    // Electron shell
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, visualRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.stroke();
                } else {
                    // Plum Pudding Model
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, visualRadius, 0, Math.PI * 2);
                    
                    let grad = ctx.createRadialGradient(this.x, this.y, 10, this.x, this.y, visualRadius);
                    grad.addColorStop(0, 'rgba(255, 152, 0, 0.3)'); 
                    grad.addColorStop(1, 'rgba(255, 152, 0, 0.05)');
                    ctx.fillStyle = grad;
                    ctx.fill();

                    // Electrons
                    ctx.fillStyle = 'rgba(50, 50, 50, 0.6)';
                    ctx.font = "12px Arial";
                    ctx.fillText("-", this.x - visualRadius*0.3, this.y - visualRadius*0.3);
                    ctx.fillText("-", this.x + visualRadius*0.3, this.y + visualRadius*0.2);
                    ctx.fillText("-", this.x - visualRadius*0.2, this.y + visualRadius*0.5);
                    ctx.fillText("-", this.x + visualRadius*0.1, this.y - visualRadius*0.6);
                }
            }
        }

        class Particle {
            constructor() {
                this.reset();
                this.x = -10;
            }

            reset() {
                this.x = 0;
                let spread = height * 0.6; 
                this.y = (height / 2) - (spread/2) + Math.random() * spread;
                
                this.speed = parseFloat(speedSlider.value);
                this.vx = this.speed;
                this.vy = 0;
                
                this.history = [];
                this.dead = false;
                this.deflected = false;
                
                totalParticles++;
                uiTotal.innerText = totalParticles;
            }

            update() {
                let forceX = 0;
                let forceY = 0;

                for (let atom of atoms) {
                    let dx = this.x - atom.x;
                    let dy = this.y - atom.y;
                    let distSq = dx*dx + dy*dy;
                    let dist = Math.sqrt(distSq);

                    if (MODE === 'rutherford') {
                        if (dist > 2 && dist < 150) {
                            let f = RUTH_K / distSq; 
                            forceX += f * (dx / dist);
                            forceY += f * (dy / dist);
                        }
                    } else {
                        if (dist < ATOM_RADIUS_PLUM) {
                            let strength = PLUM_K * (dist / (ATOM_RADIUS_PLUM * ATOM_RADIUS_PLUM)); 
                            forceX += strength * (dx / dist);
                            forceY += strength * (dy / dist);
                        }
                    }
                }

                this.vx += forceX;
                this.vy += forceY;

                this.x += this.vx;
                this.y += this.vy;

                if (this.history.length === 0 || 
                    Math.abs(this.x - this.history[this.history.length-1].x) > 4 ||
                    Math.abs(this.y - this.history[this.history.length-1].y) > 4) {
                    this.history.push({x: this.x, y: this.y});
                }
                if (this.history.length > 40) this.history.shift();

                if (MODE === 'rutherford' && !this.deflected) {
                    if (this.vx < 0) {
                        this.deflected = true;
                        backScatters++;
                        uiHit.innerText = backScatters;
                    }
                }

                if (this.x > width + 50 || this.x < -50 || this.y < -50 || this.y > height + 50) {
                    this.dead = true;
                }
            }

            draw() {
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(21, 101, 192, 0.3)';
                ctx.lineWidth = 2;
                if (this.history.length > 0) {
                    ctx.moveTo(this.history[0].x, this.history[0].y);
                    for (let p of this.history) ctx.lineTo(p.x, p.y);
                }
                ctx.lineTo(this.x, this.y);
                ctx.stroke();

                ctx.fillStyle = '#1565C0';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2.5, 0, Math.PI*2);
                ctx.fill();
            }
        }

        // --- Main Logic ---

        function initAtoms() {
            atoms = [];
            const rows = 3;
            const cols = 3;
            
            const maxSpacingX = (width * 0.8) / (cols - 1);
            const maxSpacingY = (height * 0.8) / (rows - 1);
            
            const spacing = Math.max(80, Math.min(220, Math.min(maxSpacingX, maxSpacingY)));
            
            let startX = (width / 2) - ((cols-1) * spacing) / 2;
            let startY = (height / 2) - ((rows-1) * spacing) / 2;

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    let offY = (c % 2 === 0) ? 0 : (spacing * 0.2); 
                    atoms.push(new Atom(startX + c*spacing, startY + r*spacing + offY));
                }
            }
        }

        function loop() {
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, width, height);

            for (let a of atoms) a.draw(showStructure);

            if (!isPaused) {
                spawnTimer++;
                if (spawnTimer > 5) {
                    particles.push(new Particle());
                    spawnTimer = 0;
                }

                for (let i = particles.length - 1; i >= 0; i--) {
                    let p = particles[i];
                    p.update();
                    if (p.dead) particles.splice(i, 1);
                }
            }

            for (let p of particles) p.draw();

            if (isPaused) {
                ctx.fillStyle = 'rgba(50, 50, 50, 0.8)';
                ctx.font = 'bold 16px Arial';
                ctx.fillText("PAUSED", 20, 30);
            }
            
            if (!showStructure) {
                ctx.fillStyle = 'rgba(100, 100, 100, 0.8)';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'right';
                ctx.fillText("Gold Foil View (Structure Hidden)", width - 20, 30);
                ctx.textAlign = 'start';
            }

            requestAnimationFrame(loop);
        }

        // --- Event Listeners ---

        btnPause.onclick = () => {
            isPaused = !isPaused;
            btnPause.innerText = isPaused ? "Resume" : "Pause";
            btnPause.classList.toggle('active', isPaused);
        };

        btnToggleAtoms.onclick = () => {
            showStructure = !showStructure;
            btnToggleAtoms.innerText = showStructure ? "Hide Structure" : "Show Structure";
            btnToggleAtoms.classList.toggle('active', !showStructure);
        };

        document.getElementById('btn-clear').onclick = () => {
            particles = [];
            totalParticles = 0;
            backScatters = 0;
            uiTotal.innerText = "0";
            uiHit.innerText = "0";
        };

        btnPlum.onclick = () => {
            MODE = 'plum';
            btnPlum.classList.add('active');
            btnRuth.classList.remove('active');
            legendText.innerText = "Positive charge is spread out. The weak electric field causes only minor deviations. No backscattering.";
            particles = [];
        };

        btnRuth.onclick = () => {
            MODE = 'rutherford';
            btnRuth.classList.add('active');
            btnPlum.classList.remove('active');
            legendText.innerText = "Positive charge is concentrated. Direct hits cause massive deflection (backscattering).";
            particles = [];
        };

        // Init
        resize();
        loop();

    </script>
</body>
</html>