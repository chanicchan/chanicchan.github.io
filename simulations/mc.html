<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Grader: Handwritten MCQ</title>
    <!-- Import Tesseract.js for OCR -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Camera Container */
        #camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background: black;
            overflow: hidden;
            border-radius: 8px;
        }
        video {
            width: 100%;
            height: auto;
            display: block;
        }
        /* The Grid Overlay */
        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* Processing animation */
        .processing-box {
            border: 2px solid #facc15;
            background: rgba(250, 204, 21, 0.2);
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">üìù QuickGrade AI</h1>
            <div class="space-x-4">
                <button onclick="switchTab('key')" class="hover:text-indigo-200 font-semibold">Answer Key</button>
                <button onclick="switchTab('scan')" class="hover:text-indigo-200 font-semibold">Scanner</button>
                <button onclick="switchTab('stats')" class="hover:text-indigo-200 font-semibold">Analysis</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
        
        <!-- TAB 1: ANSWER KEY -->
        <div id="tab-key" class="tab-content active bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4 text-gray-800">1. Set Correct Answers</h2>
            <p class="text-gray-600 mb-4 text-sm">Select the correct option for each question.</p>
            
            <div class="grid grid-cols-5 gap-4" id="key-grid">
                <!-- Generated by JS -->
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="switchTab('scan')" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                    Next: Start Scanning ‚Üí
                </button>
            </div>
        </div>

        <!-- TAB 2: SCANNER -->
        <div id="tab-scan" class="tab-content">
            <div class="bg-white p-4 rounded-lg shadow mb-4 text-center">
                <h2 class="text-lg font-bold text-gray-700">Align Paper & Scan</h2>
                <p class="text-xs text-gray-500">Ensure good lighting. Align the grid boxes with the red overlay.</p>
            </div>

            <div id="camera-wrapper">
                <video id="video" autoplay playsinline></video>
                <canvas id="overlay-canvas"></canvas>
            </div>

            <div class="flex justify-center gap-4 mt-4">
                <button id="btn-camera" onclick="startCamera()" class="bg-gray-600 text-white px-4 py-3 rounded flex items-center gap-2">
                    üì∑ Start Camera
                </button>
                <button id="btn-capture" onclick="captureAndProcess()" class="bg-indigo-600 text-white px-6 py-3 rounded font-bold shadow-lg disabled:opacity-50" disabled>
                    ‚ú® Scan Paper
                </button>
            </div>

            <!-- Live Processing Feedback -->
            <div id="processing-status" class="hidden mt-4 bg-yellow-50 border border-yellow-200 p-3 rounded text-yellow-800 text-center text-sm">
                Processing Question <span id="proc-q-num">1</span>/15... <br>
                <span class="text-xs text-gray-500">(This takes a moment. AI is reading handwriting...)</span>
            </div>

            <!-- Single Student Result Review -->
            <div id="review-panel" class="hidden mt-6 bg-white p-4 rounded-lg shadow border-t-4 border-indigo-500">
                <h3 class="font-bold text-lg mb-2">Scan Results</h3>
                <p class="text-xs text-gray-500 mb-4">Review detected answers. Tap a box to correct mistakes.</p>
                
                <div id="results-grid" class="grid grid-cols-5 gap-2"></div>
                
                <div class="mt-4 flex justify-between items-center bg-gray-100 p-3 rounded">
                    <div>
                        <span class="text-sm font-bold text-gray-600">Score:</span>
                        <span id="current-score" class="text-2xl font-bold text-indigo-600">0/15</span>
                    </div>
                    <button onclick="saveStudentData()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">
                        Save & Scan Next
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB 3: STATISTICS -->
        <div id="tab-stats" class="tab-content bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Class Analysis</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded border border-blue-100 text-center">
                    <div class="text-sm text-blue-600">Papers Scanned</div>
                    <div class="text-3xl font-bold text-blue-800" id="stat-count">0</div>
                </div>
                <div class="bg-green-50 p-4 rounded border border-green-100 text-center">
                    <div class="text-sm text-green-600">Average Score</div>
                    <div class="text-3xl font-bold text-green-800" id="stat-avg">0%</div>
                </div>
                <div class="bg-purple-50 p-4 rounded border border-purple-100 text-center">
                    <div class="text-sm text-purple-600">Highest Score</div>
                    <div class="text-3xl font-bold text-purple-800" id="stat-high">0</div>
                </div>
            </div>

            <h3 class="font-bold text-gray-700 mb-2">Detailed Log</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">Student #</th>
                            <th class="px-4 py-2">Score</th>
                            <th class="px-4 py-2">Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Hidden Canvas for Image Processing -->
        <canvas id="process-canvas" class="hidden"></canvas>

    </main>

    <script>
        // --- Configuration ---
        const TOTAL_QUESTIONS = 15;
        const GRID_COLS = 10; // Image has 10 columns
        const GRID_ROWS = 2;  // Image has 2 rows
        
        // State
        let answerKey = new Array(TOTAL_QUESTIONS).fill('A');
        let currentScan = new Array(TOTAL_QUESTIONS).fill('?');
        let classData = [];
        let stream = null;
        
        // The specific layout of the user's image
        // Row 1: Q1-10
        // Row 2: Q11-15 (First 5 cols only)
        const boxLayout = [];
        for(let i=0; i<10; i++) boxLayout.push({row:0, col:i, id: i+1});
        for(let i=0; i<5; i++) boxLayout.push({row:1, col:i, id: i+11});

        // --- Initialization ---
        window.onload = () => {
            initKeyGen();
        };

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // --- Tab 1: Key Generation ---
        function initKeyGen() {
            const container = document.getElementById('key-grid');
            container.innerHTML = '';
            for(let i=1; i<=TOTAL_QUESTIONS; i++) {
                const div = document.createElement('div');
                div.className = "flex flex-col gap-1";
                div.innerHTML = `
                    <label class="text-xs font-bold text-gray-500">Q${i}</label>
                    <select class="border rounded p-1 text-sm bg-gray-50" onchange="updateKey(${i-1}, this.value)">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                `;
                container.appendChild(div);
            }
        }

        function updateKey(index, val) {
            answerKey[index] = val;
        }

        // --- Tab 2: Camera & Overlay ---
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    resizeOverlay();
                    drawOverlay();
                    document.getElementById('btn-capture').disabled = false;
                    // Keep redrawing overlay in case of resize
                    window.addEventListener('resize', () => { resizeOverlay(); drawOverlay(); });
                };
            } catch (err) {
                alert("Error accessing camera: " + err.message);
            }
        }

        function resizeOverlay() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('overlay-canvas');
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;
        }

        function drawOverlay() {
            const canvas = document.getElementById('overlay-canvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.clearRect(0, 0, w, h);

            // Define Grid Area (Assume paper takes up 90% width, centered)
            const gridW = w * 0.95;
            const gridH = gridW * 0.2; // Aspect ratio based on 2 rows vs 10 cols roughly
            const startX = (w - gridW) / 2;
            const startY = (h - gridH) / 2;

            const cellW = gridW / GRID_COLS;
            const cellH = gridH / GRID_ROWS;

            ctx.strokeStyle = 'rgba(255, 0, 0, 0.7)';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';

            // Draw boxes for Q1-15 based on layout
            boxLayout.forEach(box => {
                const x = startX + box.col * cellW;
                const y = startY + box.row * cellH;
                
                ctx.strokeRect(x, y, cellW, cellH);
                
                // Number label
                ctx.fillStyle = "red";
                ctx.font = "12px Arial";
                ctx.fillText(box.id, x + 5, y + 15);
            });
            
            // Helper text
            ctx.fillStyle = "yellow";
            ctx.font = "16px Arial";
            ctx.textAlign = "center";
            ctx.fillText("Align Answer Grid Here", w/2, startY - 10);
        }

        // --- Processing Logic ---
        async function captureAndProcess() {
            const video = document.getElementById('video');
            const procCanvas = document.getElementById('process-canvas');
            const overlayCanvas = document.getElementById('overlay-canvas');
            const procCtx = procCanvas.getContext('2d');

            // 1. Capture Frame
            procCanvas.width = video.videoWidth;
            procCanvas.height = video.videoHeight;
            procCtx.drawImage(video, 0, 0);

            // 2. Calculate Coordinates (Must map display coords to video coords)
            const scaleX = video.videoWidth / overlayCanvas.width;
            const scaleY = video.videoHeight / overlayCanvas.height;

            const dispW = overlayCanvas.width;
            const dispH = overlayCanvas.height;
            
            const gridW = dispW * 0.95;
            const gridH = gridW * 0.2;
            const startX = (dispW - gridW) / 2;
            const startY = (dispH - gridH) / 2;
            const cellW = gridW / GRID_COLS;
            const cellH = gridH / GRID_ROWS;

            // UI Update
            document.getElementById('processing-status').classList.remove('hidden');
            document.getElementById('review-panel').classList.add('hidden');
            document.getElementById('btn-capture').disabled = true;

            // 3. Process Each Box
            currentScan = [];
            
            for (let i = 0; i < boxLayout.length; i++) {
                const box = boxLayout[i];
                
                // Update UI Progress
                document.getElementById('proc-q-num').innerText = box.id;

                // Crop
                // We crop slightly inside the box to avoid grid lines (padding 15%)
                const paddingX = cellW * 0.15;
                const paddingY = cellH * 0.15;
                
                const cropX = (startX + box.col * cellW + paddingX) * scaleX;
                const cropY = (startY + box.row * cellH + paddingY) * scaleY;
                const cropW = (cellW - 2*paddingX) * scaleX;
                const cropH = (cellH - 2*paddingY) * scaleY;

                // Extract image data
                const imgData = procCtx.getImageData(cropX, cropY, cropW, cropH);
                
                // Create a temp canvas for Tesseract
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = cropW;
                tempCanvas.height = cropH;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(imgData, 0, 0);

                // Pre-process (High Contrast / Thresholding helps OCR)
                // Simulating basic thresholding here could help, but let's try raw first
                
                // Run OCR
                const result = await Tesseract.recognize(
                    tempCanvas.toDataURL(),
                    'eng',
                    { 
                        logger: m => {}, // Silent logger
                        tessedit_char_whitelist: 'ABCD' // RESTRICT TO ONLY ANSWERS
                    }
                );

                // Clean Result
                let char = result.data.text.trim().toUpperCase();
                // Simple fallback heuristics for common OCR errors
                if (char.includes('A')) char = 'A';
                else if (char.includes('B') || char === '8') char = 'B';
                else if (char.includes('C') || char === '(') char = 'C';
                else if (char.includes('D') || char === '0' || char === 'O') char = 'D';
                else char = '?';

                currentScan.push(char);
            }

            // Finish
            document.getElementById('processing-status').classList.add('hidden');
            document.getElementById('btn-capture').disabled = false;
            renderResults();
        }

        // --- Results & Grading ---
        function renderResults() {
            const grid = document.getElementById('results-grid');
            grid.innerHTML = '';
            let score = 0;

            currentScan.forEach((ans, idx) => {
                const correctAns = answerKey[idx];
                const isCorrect = ans === correctAns;
                if(isCorrect) score++;

                const div = document.createElement('div');
                // Color code: Green=Correct, Red=Wrong, Gray=Unsure
                const bgClass = isCorrect ? 'bg-green-100 border-green-500' : (ans === '?' ? 'bg-gray-100 border-gray-400' : 'bg-red-100 border-red-500');
                
                div.className = `border-2 rounded p-2 text-center cursor-pointer hover:shadow-md transition ${bgClass}`;
                div.innerHTML = `
                    <div class="text-xs text-gray-500 font-bold">Q${idx+1}</div>
                    <div class="text-xl font-bold">${ans}</div>
                    ${!isCorrect ? `<div class="text-xs text-green-600">Exp: ${correctAns}</div>` : ''}
                `;
                
                // Manual Correction Click
                div.onclick = () => {
                    const newVal = prompt(`Correct Q${idx+1} (Current: ${ans})`, correctAns);
                    if(newVal && ['A','B','C','D'].includes(newVal.toUpperCase())) {
                        currentScan[idx] = newVal.toUpperCase();
                        renderResults(); // Re-render
                    }
                };

                grid.appendChild(div);
            });

            document.getElementById('review-panel').classList.remove('hidden');
            document.getElementById('current-score').innerText = `${score}/${TOTAL_QUESTIONS}`;
        }

        function saveStudentData() {
            let score = 0;
            currentScan.forEach((ans, idx) => {
                if(ans === answerKey[idx]) score++;
            });

            const studentId = classData.length + 1;
            classData.push({
                id: studentId,
                score: score,
                answers: [...currentScan]
            });

            // Update Stats Tab
            updateStats();
            
            // Reset Scan Tab
            document.getElementById('review-panel').classList.add('hidden');
            alert(`Student #${studentId} Saved! Score: ${score}`);
        }

        // --- Statistics ---
        function updateStats() {
            const count = classData.length;
            const totalScore = classData.reduce((sum, s) => sum + s.score, 0);
            const avg = count > 0 ? (totalScore / count).toFixed(1) : 0;
            const high = classData.reduce((max, s) => Math.max(max, s.score), 0);
            const avgPerc = count > 0 ? ((avg / TOTAL_QUESTIONS) * 100).toFixed(0) + '%' : '0%';

            document.getElementById('stat-count').innerText = count;
            document.getElementById('stat-avg').innerText = avgPerc;
            document.getElementById('stat-high').innerText = high;

            const tbody = document.getElementById('stats-table');
            tbody.innerHTML = '';
            classData.forEach(s => {
                const row = `
                    <tr class="bg-white border-b">
                        <td class="px-4 py-2 font-medium text-gray-900">Student ${s.id}</td>
                        <td class="px-4 py-2">${s.score} / ${TOTAL_QUESTIONS}</td>
                        <td class="px-4 py-2">${((s.score/TOTAL_QUESTIONS)*100).toFixed(0)}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

    </script>
</body>
</html>