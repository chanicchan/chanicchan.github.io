<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Grader: Handwritten MCQ</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; user-select: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Compact Camera View */
        #camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 320px; /* Fixed height to not fill screen */
            margin: 0 auto;
            background: #000;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Fill the box */
            opacity: 0.8;
        }
        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Floating Status Badge */
        .status-badge {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .indicator { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
        .indicator.active { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navigation -->
    <nav class="bg-indigo-600 text-white p-3 shadow-md shrink-0">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold tracking-tight">üìù QuickGrade Live</h1>
            <div class="flex text-xs font-semibold bg-indigo-800 rounded-lg p-1">
                <button onclick="switchTab('key')" id="nav-key" class="px-3 py-1 rounded hover:bg-indigo-600">Key</button>
                <button onclick="switchTab('scan')" id="nav-scan" class="px-3 py-1 rounded bg-indigo-500">Scan</button>
                <button onclick="switchTab('stats')" id="nav-stats" class="px-3 py-1 rounded hover:bg-indigo-600">Stats</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow relative overflow-y-auto">
        
        <!-- TAB 1: ANSWER KEY -->
        <div id="tab-key" class="tab-content p-4 max-w-md mx-auto">
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="font-bold mb-2 text-gray-800">Answer Key Setup</h2>
                <div class="grid grid-cols-5 gap-2 mb-4" id="key-grid"></div>
                <button onclick="switchTab('scan')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow">
                    Ready to Scan ‚Üí
                </button>
            </div>
        </div>

        <!-- TAB 2: SCANNER -->
        <div id="tab-scan" class="tab-content active p-2 max-w-md mx-auto h-full flex flex-col">
            
            <!-- Camera Section -->
            <div id="camera-wrapper">
                <video id="video" autoplay playsinline></video>
                <canvas id="overlay-canvas"></canvas>
                
                <!-- Overlay UI -->
                <div class="status-badge">
                    <div id="status-dot" class="indicator"></div>
                    <span id="scan-status-text">Camera Offline</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="mt-3 grid grid-cols-2 gap-3 shrink-0">
                <button id="btn-toggle-cam" onclick="toggleCamera()" class="bg-gray-700 text-white py-3 rounded-lg font-bold shadow flex justify-center items-center gap-2">
                    üì∑ Start Cam
                </button>
                <button id="btn-reset" onclick="resetCurrentScan()" class="bg-red-100 text-red-600 py-3 rounded-lg font-bold shadow">
                    ‚Ü∫ Reset
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="mt-4 bg-white p-3 rounded-lg shadow shrink-0">
                <div class="flex justify-between text-sm mb-1 font-semibold text-gray-600">
                    <span>Progress</span>
                    <span id="progress-text">0/15</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Live Results Grid -->
            <div class="mt-3 flex-grow overflow-y-auto bg-white rounded-lg shadow p-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Detected Answers</h3>
                <div id="live-results" class="grid grid-cols-5 gap-2">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Save Button -->
            <button id="btn-save" onclick="saveStudent()" class="mt-3 w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow disabled:opacity-50 disabled:grayscale" disabled>
                ‚úÖ Save Result
            </button>
        </div>

        <!-- TAB 3: STATISTICS -->
        <div id="tab-stats" class="tab-content p-4 max-w-md mx-auto">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-700" id="stat-total">0</div>
                    <div class="text-xs text-blue-600 font-bold uppercase">Papers</div>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-green-700" id="stat-avg">0%</div>
                    <div class="text-xs text-green-600 font-bold uppercase">Average</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500">
                        <tr>
                            <th class="px-4 py-2">ID</th>
                            <th class="px-4 py-2">Score</th>
                            <th class="px-4 py-2">%</th>
                        </tr>
                    </thead>
                    <tbody id="stats-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Worker Canvas -->
        <canvas id="worker-canvas" class="hidden"></canvas>
    </main>

    <script>
        // --- Config ---
        const TOTAL_Q = 15;
        // Paper layout definition (2 Rows, 10 Cols grid)
        // Q1-10 in Row 0, Q11-15 in Row 1
        const LAYOUT = [];
        for(let i=0; i<10; i++) LAYOUT.push({id: i+1, r:0, c:i});
        for(let i=0; i<5; i++) LAYOUT.push({id: i+11, r:1, c:i});

        // --- State ---
        let state = {
            answers: new Array(TOTAL_Q).fill(null), // null = not scanned
            key: new Array(TOTAL_Q).fill('A'),
            isScanning: false,
            stream: null,
            worker: null,
            queue: [], // Indices of questions waiting to be scanned
            processing: false
        };
        let classData = [];

        // --- Init ---
        window.onload = async () => {
            initKeyUI();
            renderLiveGrid();
            // Initialize Tesseract Worker upfront
            state.worker = Tesseract.createWorker({
                logger: m => console.log(m.status)
            });
            await state.worker.load();
            await state.worker.loadLanguage('eng');
            await state.worker.initialize('eng');
            await state.worker.setParameters({
                tessedit_char_whitelist: 'ABCD' // Optimize for multiple choice
            });
            console.log("OCR Worker Ready");
        };

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            // Update Nav style
            ['key','scan','stats'].forEach(n => {
                const btn = document.getElementById('nav-'+n);
                if(n===t) btn.className = "px-3 py-1 rounded bg-indigo-500";
                else btn.className = "px-3 py-1 rounded hover:bg-indigo-600";
            });
        }

        // --- UI Generators ---
        function initKeyUI() {
            const grid = document.getElementById('key-grid');
            grid.innerHTML = state.key.map((k, i) => `
                <div class="flex flex-col">
                    <label class="text-[10px] font-bold text-gray-400 text-center">${i+1}</label>
                    <select onchange="state.key[${i}]=this.value" class="border rounded text-center text-sm p-1 bg-gray-50">
                        ${['A','B','C','D'].map(opt => `<option ${k===opt?'selected':''}>${opt}</option>`).join('')}
                    </select>
                </div>
            `).join('');
        }

        function renderLiveGrid() {
            const grid = document.getElementById('live-results');
            grid.innerHTML = state.answers.map((ans, i) => {
                const isDone = ans !== null;
                const color = isDone ? 'bg-green-100 border-green-500 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-300';
                return `
                    <div onclick="manualEdit(${i})" class="border-2 rounded p-2 text-center cursor-pointer transition-all ${color}">
                        <div class="text-[10px] font-bold mb-1">Q${i+1}</div>
                        <div class="text-xl font-bold h-6 leading-none">${ans || '?'}</div>
                    </div>
                `;
            }).join('');
            
            // Update Progress
            const doneCount = state.answers.filter(a => a).length;
            document.getElementById('progress-text').innerText = `${doneCount}/${TOTAL_Q}`;
            document.getElementById('progress-bar').style.width = `${(doneCount/TOTAL_Q)*100}%`;
            document.getElementById('btn-save').disabled = doneCount === 0; // Can save partials
        }

        function manualEdit(idx) {
            const val = prompt(`Edit Question ${idx+1}`, state.answers[idx] || "");
            if(val && "ABCD".includes(val.toUpperCase())) {
                state.answers[idx] = val.toUpperCase();
                renderLiveGrid();
                drawOverlay(); // Refresh overlay colors
            }
        }

        // --- Camera Logic ---
        async function toggleCamera() {
            const btn = document.getElementById('btn-toggle-cam');
            const statusText = document.getElementById('scan-status-text');
            const statusDot = document.getElementById('status-dot');

            if(state.stream) {
                // Stop
                state.stream.getTracks().forEach(t => t.stop());
                state.stream = null;
                state.isScanning = false;
                btn.innerText = "üì∑ Start Cam";
                statusText.innerText = "Camera Offline";
                statusDot.classList.remove('active');
                btn.classList.replace('bg-red-600', 'bg-gray-700');
            } else {
                // Start
                try {
                    state.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment", width: {ideal: 1920} } 
                    });
                    const vid = document.getElementById('video');
                    vid.srcObject = state.stream;
                    vid.onloadedmetadata = () => {
                        state.isScanning = true;
                        btn.innerText = "‚èπ Stop Cam";
                        statusText.innerText = "Scanning...";
                        statusDot.classList.add('active');
                        btn.classList.replace('bg-gray-700', 'bg-red-600');
                        
                        // Fill queue with pending indices
                        refillQueue();
                        requestAnimationFrame(scanLoop);
                    };
                } catch(e) {
                    alert("Camera Error: " + e.message);
                }
            }
        }

        function resetCurrentScan() {
            state.answers.fill(null);
            renderLiveGrid();
            refillQueue();
        }

        function refillQueue() {
            // Only add indices that are null
            state.queue = state.answers.map((a, i) => a === null ? i : -1).filter(i => i !== -1);
        }

        // --- Core Loop ---
        function scanLoop() {
            if(!state.isScanning) return;

            drawOverlay(); // Always draw UI
            
            // AI Processing Hook
            if(!state.processing && state.queue.length > 0) {
                processNextInQueue();
            }

            requestAnimationFrame(scanLoop);
        }

        // --- Overlay Drawing ---
        function drawOverlay() {
            const vid = document.getElementById('video');
            const cvs = document.getElementById('overlay-canvas');
            const ctx = cvs.getContext('2d');

            // Match dimensions
            if(cvs.width !== vid.clientWidth) {
                cvs.width = vid.clientWidth;
                cvs.height = vid.clientHeight;
            }

            const w = cvs.width;
            const h = cvs.height;
            ctx.clearRect(0,0,w,h);

            // Layout Calculation (Assume strip fits width with margin)
            // Aspect Ratio of the strip image provided is roughly 10:2 (5:1)
            // We center it in the view
            const margin = 20;
            const gridW = w - (margin*2);
            const gridH = gridW / 5; // 10 cols / 2 rows = 5 ratio
            const startX = margin;
            const startY = (h - gridH) / 2;
            
            const cellW = gridW / 10;
            const cellH = gridH / 2;

            // Draw Grid
            LAYOUT.forEach((box, i) => {
                const x = startX + box.c * cellW;
                const y = startY + box.r * cellH;
                
                const isScanned = state.answers[i] !== null;
                const isProcessing = state.processingIdx === i;

                ctx.lineWidth = 2;
                
                if(isScanned) {
                    // Success State (Green)
                    ctx.strokeStyle = '#22c55e';
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.3)';
                    ctx.fillRect(x, y, cellW, cellH);
                    ctx.strokeRect(x, y, cellW, cellH);
                    
                    // Draw Letter
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(state.answers[i], x + cellW/2, y + cellH/1.5);
                } else if (isProcessing) {
                    // Active Scan State (Yellow)
                    ctx.strokeStyle = '#eab308';
                    ctx.strokeRect(x, y, cellW, cellH);
                } else {
                    // Pending State (Red outline)
                    ctx.strokeStyle = 'rgba(239, 68, 68, 0.5)';
                    ctx.strokeRect(x, y, cellW, cellH);
                }
            });

            // Guide Box
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.strokeRect(startX - 5, startY - 5, gridW + 10, gridH + 10);
        }

        // --- AI Logic ---
        async function processNextInQueue() {
            if(!state.worker) return;
            
            // Pick next item
            // We rotate queue so we don't get stuck on a hard question forever
            const idx = state.queue.shift(); 
            state.processing = true;
            state.processingIdx = idx; // For visual highlight

            try {
                // 1. Extract Image Patch
                const vid = document.getElementById('video');
                const workCvs = document.getElementById('worker-canvas');
                const workCtx = workCvs.getContext('2d');
                
                // coordinate math (Video vs Display scaling)
                // We need to calculate where the box `idx` is on the actual VIDEO frame
                const dispCvs = document.getElementById('overlay-canvas');
                const scaleX = vid.videoWidth / dispCvs.width;
                const scaleY = vid.videoHeight / dispCvs.height;

                // Re-calc layout (dupe code, simple enough)
                const margin = 20;
                const gridW = dispCvs.width - (margin*2);
                const gridH = gridW / 5;
                const startX = margin;
                const startY = (dispCvs.height - gridH) / 2;
                const cellW = gridW / 10;
                const cellH = gridH / 2;

                const boxData = LAYOUT[idx];
                const px = 5; // padding to avoid borders
                
                const cropX = (startX + boxData.c * cellW + px) * scaleX;
                const cropY = (startY + boxData.r * cellH + px) * scaleY;
                const cropW = (cellW - px*2) * scaleX;
                const cropH = (cellH - px*2) * scaleY;

                workCvs.width = cropW;
                workCvs.height = cropH;
                workCtx.drawImage(vid, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

                // 2. OCR
                const res = await state.worker.recognize(workCvs.toDataURL());
                const char = cleanChar(res.data.text);

                // 3. Validate
                if(char) {
                    state.answers[idx] = char;
                    renderLiveGrid();
                    // Do not put back in queue
                } else {
                    // Failed, push back to end of queue to try again later
                    state.queue.push(idx);
                }

            } catch(e) {
                console.error("OCR Error", e);
                state.queue.push(idx);
            }

            state.processing = false;
            state.processingIdx = -1;
        }

        function cleanChar(text) {
            const t = text.toUpperCase();
            if(t.includes('A')) return 'A';
            if(t.includes('B') || t.includes('8')) return 'B';
            if(t.includes('C') || t.includes('(')) return 'C';
            if(t.includes('D') || t.includes('0') || t.includes('O')) return 'D';
            return null;
        }

        // --- Save & Stats ---
        function saveStudent() {
            let score = 0;
            state.answers.forEach((a, i) => {
                if(a === state.key[i]) score++;
            });

            const sObj = { id: classData.length+1, score };
            classData.push(sObj);
            
            // Update Stats UI
            document.getElementById('stat-total').innerText = classData.length;
            const avg = classData.reduce((a,b)=>a+b.score,0) / classData.length;
            document.getElementById('stat-avg').innerText = Math.round((avg/TOTAL_Q)*100) + '%';
            
            const row = `<tr class="bg-white border-b"><td class="px-4 py-2">#${sObj.id}</td><td class="px-4 py-2">${score}</td><td class="px-4 py-2">${Math.round((score/TOTAL_Q)*100)}%</td></tr>`;
            document.getElementById('stats-list').innerHTML += row;

            // Reset for next
            resetCurrentScan();
            alert(`Saved! Score: ${score}/${TOTAL_Q}`);
        }

    </script>
</body>
</html>